#!/bin/bash
ERR_INTERFACE=1
MESS_NB_ARGUMENT="$0 risque de ne pas bien marcher sans argument..."
MESSAGE_ERR_INTERFACE="Il y a eu un souci lors de la création de l'interface"
MESSAGE_INTERFACE="L'interface a bien été créée"
PS3="entrer votre choix : "
switch="$(head -n 7 /etc/default/lxc-net | tail -1 | cut -d\" -f2)"
options=("demarrer" "renommer" "changer l'ip de l'interface" "changer le masque de sous-reseau" "changer la plage d'ip du DHCP" "quitter")
NOM_DU_SWITCH="LXC_BRIDGE="
IP="LXC_ADDR="
NETMASK="LXC_NETMASK="
PLAGE="LXC_DHCP_RANGE="
NETWORK="LXC_NETWORK="
NBIP="LXC_DHCP_MAX="

rename () {
	f="/etc/default/lxc-net" #fichier de config
	sed -i "s@$1\".*\"@$1\"$2\"@g" $f
}

clear
select opt in "${options[@]}"
do
	case $REPLY in
		1)
			if ip tuntap add mode tap tap0 && ip link set dev tap0 master $switch && ip link set tap0 up
			then
				echo $MESSAGE_INTERFACE
				exit 0
			else
				echo $MESSAGE_ERR_INTERFACE
				exit $ERR_INTERFACE
			fi
			;;
		2)
			read -p "Quel nom voulez vous donner au switch ? " nouveauNom 
			rename $NOM_DU_SWITCH $nouveauNom
			;;
		3)
			read -p "Quel adresse voulez vous donner a votre switch ? " nouvelIp
			rename $IP $nouvelIp
			;;
		4)
			read -p "Quel masque de sous-reseau voulez vous donner au switch ? " nouveauMask
			rename $NETMASK $nouveauMask
			#TODO calculer le nouveau LXC_NETWORK
			read -p "Entrer le nouveau netmask du reseau : " nouveauNetwork
			rename $NETWORK $nouveauNetwork
			;;
		5)
			read -p "Quel plage d'adresse IP voulez vous donner au DHCP ? (IP_debut,IP_fin) " nouvellePlage
			rename $PLAGE $nouvellePlage
			#TODO calculer le nombre d'ip
			read -p "Entrer le nombre d'adresse IP disponible : " nb
			rename $NBIP $nb
			;;
		6)
			break
			;;
	esac
done
